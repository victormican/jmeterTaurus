name: Performance Tests with Taurus and k6

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'k6-test.js'
      - 'performanceTaurusk6.yml'
      - '.github/workflows/performance.yml'
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Ejecutar diariamente a las 2 AM
  workflow_dispatch:  # Permite ejecución manual

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install k6
      run: |
        sudo apt-get update
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D78C6C768530E4EEF
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Install Taurus
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip
        pip3 install bzt
    
    - name: Run Taurus Performance Test
      id: taurus-run
      run: |
        echo "Running Taurus performance test..."
        bzt performanceTaurusk6.yml
        
        # Verificar si el archivo de resultados existe
        if [ -f "test-results.json" ]; then
          echo "Results file created successfully"
          
          # Extraer métricas clave (ejemplo)
          if [ -f "summary.json" ]; then
            echo "Extracting key metrics..."
            cat summary.json | jq -r '
              "Performance Test Summary:",
              "========================",
              "Total Duration: \(.metrics.test_duration.values.avg)s",
              "Total Requests: \(.metrics.http_reqs.values.count)",
              "Request Rate: \(.metrics.http_reqs.values.rate)/s",
              "Average Response Time: \(.metrics.http_req_duration.values.avg)ms",
              "95th Percentile: \(.metrics.http_req_duration.values."p(95)")ms",
              "Failed Requests: \(.metrics.http_req_failed.values.rate * 100)%",
              ""
            '
          fi
        else
          echo "Error: Test results file not found"
          exit 1
        fi
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: performance-test-results
        path: |
          test-results.json
          summary.json
          report.xml
        retention-days: 30
    
    - name: Upload JUnit Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: junit-report
        path: report.xml
    
    - name: Check Performance Thresholds
      id: check-thresholds
      run: |
        if [ -f "summary.json" ]; then
          # Extraer métricas y verificar umbrales
          AVG_RT=$(cat summary.json | jq -r '.metrics.http_req_duration.values.avg')
          P95=$(cat summary.json | jq -r '.metrics.http_req_duration.values."p(95)"')
          FAIL_RATE=$(cat summary.json | jq -r '.metrics.http_req_failed.values.rate * 100')
          
          echo "Current Metrics:"
          echo "Average Response Time: ${AVG_RT}ms"
          echo "95th Percentile: ${P95}ms"
          echo "Failure Rate: ${FAIL_RATE}%"
          
          # Definir umbrales (ajusta según tus necesidades)
          AVG_RT_THRESHOLD=200
          P95_THRESHOLD=500
          FAIL_RATE_THRESHOLD=5
          
          FAILED=false
          
          if (( $(echo "$AVG_RT > $AVG_RT_THRESHOLD" | bc -l) )); then
            echo "❌ Average Response Time ($AVG_RT ms) exceeds threshold ($AVG_RT_THRESHOLD ms)"
            FAILED=true
          fi
          
          if (( $(echo "$P95 > $P95_THRESHOLD" | bc -l) )); then
            echo "❌ 95th Percentile ($P95 ms) exceeds threshold ($P95_THRESHOLD ms)"
            FAILED=true
          fi
          
          if (( $(echo "$FAIL_RATE > $FAIL_RATE_THRESHOLD" | bc -l) )); then
            echo "❌ Failure Rate ($FAIL_RATE%) exceeds threshold ($FAIL_RATE_THRESHOLD%)"
            FAILED=true
          fi
          
          if [ "$FAILED" = true ]; then
            echo "Performance thresholds not met!"
            exit 1
          else
            echo "✅ All performance thresholds met!"
          fi
        else
          echo "Warning: summary.json not found, skipping threshold check"
        fi
