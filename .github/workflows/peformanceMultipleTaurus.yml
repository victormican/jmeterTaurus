name: Performance Tests (Taurus Orchestrator)

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Taurus scenario file to run'
        required: true
        default: 'taurus-jmeter.yml'

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Detect Engine
      - name: Detect Test Engine
        id: engine
        run: |
          SCENARIO="${{ github.event.inputs.test_scenario }}"

          if [[ "$SCENARIO" == *"k6"* ]]; then
            echo "engine=k6" >> $GITHUB_OUTPUT
          elif [[ "$SCENARIO" == *"gatling"* ]]; then
            echo "engine=gatling" >> $GITHUB_OUTPUT
          else
            echo "engine=jmeter" >> $GITHUB_OUTPUT
          fi

          echo "Detected engine: $SCENARIO"

      # 3Ô∏è‚É£ Java (JMeter + Gatling)
      - name: Setup Java
        if: steps.engine.outputs.engine != 'k6'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 4Ô∏è‚É£ Node.js (k6 only)
      - name: Setup Node.js
        if: steps.engine.outputs.engine == 'k6'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 4Ô∏è‚É£1Ô∏è‚É£ Install k6 (ONLY k6)
      - name: Install k6
        if: steps.engine.outputs.engine == 'k6'
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y gnupg software-properties-common
          curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/k6-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6
          k6 version

      # 5Ô∏è‚É£ Install JMeter
      - name: Install JMeter
        if: steps.engine.outputs.engine == 'jmeter'
        run: |
          set -e
          JMETER_VERSION=5.6.3
          curl -L https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz | tar -xz
          sudo mv apache-jmeter-${JMETER_VERSION} /opt/jmeter
          echo "/opt/jmeter/bin" >> $GITHUB_PATH
          jmeter --version

      # 6Ô∏è‚É£ Install JMeter Plugins
      - name: Install JMeter Plugins
        if: steps.engine.outputs.engine == 'jmeter'
        run: |
          curl -L https://jmeter-plugins.org/get/ \
            -o /opt/jmeter/lib/ext/jmeter-plugins-manager.jar

          curl -L https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar \
            -o /opt/jmeter/lib/cmdrunner-2.3.jar

          cd /opt/jmeter
          java -cp lib/ext/jmeter-plugins-manager.jar \
            org.jmeterplugins.repository.PluginManagerCMDInstaller

      # 7Ô∏è‚É£ Install Taurus
      - name: Install Taurus
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install bzt

      # 8Ô∏è‚É£ Run Taurus
      - name: Run Taurus Scenario
        run: |
          mkdir -p performance-results

          bzt ${{ github.event.inputs.test_scenario }} \
            -o settings.artifacts-dir=performance-results \
            -report

      # 9Ô∏è‚É£ JMeter HTML Report
      - name: Generate JMeter HTML Report
        if: steps.engine.outputs.engine == 'jmeter'
        run: |
          JTL=$(find performance-results -name "*kpi.jtl" -o -name "jmeter.jtl" | head -1)
          [ -z "$JTL" ] && exit 0
          jmeter -g "$JTL" -o jmeter-html-report

      # üîü Gatling HTML Report
      - name: Collect Gatling HTML Report
        if: steps.engine.outputs.engine == 'gatling'
        run: |
          mkdir -p gatling-html-report
          cp -r gatling/target/gatling/* gatling-html-report/

      # 1Ô∏è‚É£1Ô∏è‚É£ k6 HTML / Dashboard
      - name: Collect k6 HTML Report
        if: steps.engine.outputs.engine == 'k6'
        run: |
          mkdir -p k6-html-report
          cp performance-results/*.html k6-html-report/ || true

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload Artifacts
      - name: Upload Performance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            performance-results/
            jmeter-html-report/
            gatling-html-report/
            k6-html-report/
          retention-days: 30
