name: Performance Tests (Taurus Orchestrator)

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Taurus scenario file to run'
        required: false
        default: 'taurus-jmeter.yml'

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Java 17 (JMeter + Gatling)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3Ô∏è‚É£ Node.js (k6 HTML reporter)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 4Ô∏è‚É£ Install JMeter
      - name: Install JMeter
        run: |
          set -e
          JMETER_VERSION=5.6.3
          echo "Installing JMeter ${JMETER_VERSION}"
          curl -L https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz | tar -xz
          sudo mv apache-jmeter-${JMETER_VERSION} /opt/jmeter
          echo "/opt/jmeter/bin" >> $GITHUB_PATH
          /opt/jmeter/bin/jmeter --version

      # 5Ô∏è‚É£ Install JMeter Plugins
      - name: Install JMeter Plugins
        run: |
          set -e

          curl -L https://jmeter-plugins.org/get/ \
            -o /opt/jmeter/lib/ext/jmeter-plugins-manager.jar

          curl -L https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar \
            -o /opt/jmeter/lib/cmdrunner-2.3.jar

          cd /opt/jmeter

          java -cp lib/ext/jmeter-plugins-manager.jar \
            org.jmeterplugins.repository.PluginManagerCMDInstaller

          java -jar lib/cmdrunner-2.3.jar \
            --tool org.jmeterplugins.repository.PluginManagerCMD \
            install jpgc-casutg

      # 6Ô∏è‚É£ Install Taurus (BZT)
      - name: Install Taurus
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install bzt

      # 7Ô∏è‚É£ Install k6 HTML Reporter
      - name: Install k6 HTML Reporter
        run: |
          npm install -g k6-reporter

      # 8Ô∏è‚É£ Run Performance Tests with Taurus
      - name: Run Performance Tests with Taurus
        env:
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario }}
        run: |
          set -e
          mkdir -p performance-results

          echo "Running Taurus scenario: ${TEST_SCENARIO}"

          bzt ${TEST_SCENARIO} \
            -o modules.jmeter.path=/opt/jmeter \
            -o modules.jmeter.version=5.6.3 \
            -o settings.artifacts-dir=performance-results \
            -report

          echo "‚úÖ Taurus execution completed"

      # 9Ô∏è‚É£ Generate JMeter HTML Report
      - name: Generate JMeter HTML Report
        if: always()
        run: |
          set +e
          JTL=$(find performance-results -name "*kpi.jtl" -o -name "jmeter.jtl" | head -1)

          if [ -z "$JTL" ]; then
            echo "No JMeter JTL found"
            exit 0
          fi

          mkdir -p jmeter-html-report
          /opt/jmeter/bin/jmeter -g "$JTL" -o jmeter-html-report
          echo "‚úÖ JMeter HTML report generated"

      # üîü Collect Gatling HTML Report
      - name: Collect Gatling HTML Report
        if: always()
        run: |
          set +e
          if [ -d "gatling/target/gatling" ]; then
            mkdir -p gatling-html-report
            cp -r gatling/target/gatling/* gatling-html-report/
            echo "‚úÖ Gatling HTML report collected"
          else
            echo "No Gatling report found"
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Generate k6 HTML Report
      - name: Generate k6 HTML Report
        if: always()
        run: |
          set +e
          if [ -f "performance-results/k6-results.json" ]; then
            mkdir -p k6-html-report
            k6-reporter performance-results/k6-results.json \
              --output k6-html-report/index.html
            echo "‚úÖ k6 HTML report generated"
          else
            echo "No k6 JSON results found"
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload All Performance Artifacts
      - name: Upload Performance Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-reports
          path: |
            performance-results/
            jmeter-html-report/
            gatling-html-report/
            k6-html-report/
          retention-days: 30

      # 1Ô∏è‚É£3Ô∏è‚É£ Summary
      - name: Performance Summary
        if: always()
        run: |
          echo "=== PERFORMANCE PIPELINE FINISHED ==="
          echo "Artifacts available:"
          echo "- Taurus raw results"
          echo "- JMeter HTML report"
          echo "- Gatling HTML report"
          echo "- k6 HTML report"
