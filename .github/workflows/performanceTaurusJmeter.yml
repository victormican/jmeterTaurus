name: Performance Tests (Taurus with JMeter)

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'taurus-jmter.yml'

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Java 17
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3Ô∏è‚É£ Install JMeter
      - name: Install JMeter
        run: |
          set -e
          JMETER_VERSION=5.6.3
          echo "Installing JMeter ${JMETER_VERSION}"
          curl -L https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz | tar -xz
          sudo mv apache-jmeter-${JMETER_VERSION} /opt/jmeter

          echo "/opt/jmeter/bin" >> $GITHUB_PATH

          /opt/jmeter/bin/jmeter --version

      # 4Ô∏è‚É£ Install JMeter Plugins
      - name: Install JMeter Plugins
        run: |
          set -e

          # Plugin Manager
          curl -L https://jmeter-plugins.org/get/ \
            -o /opt/jmeter/lib/ext/jmeter-plugins-manager.jar

          # CmdRunner
          curl -L https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar \
            -o /opt/jmeter/lib/cmdrunner-2.3.jar

          # First JMeter run (IMPORTANT)
          /opt/jmeter/bin/jmeter --version

          # Install Plugins Manager CMD
          cd /opt/jmeter
          java -cp lib/ext/jmeter-plugins-manager.jar \
            org.jmeterplugins.repository.PluginManagerCMDInstaller

          # Install Custom Thread Groups (Ultimate Thread Group)
          java -jar lib/cmdrunner-2.3.jar \
            --tool org.jmeterplugins.repository.PluginManagerCMD \
            install jpgc-casutg

          echo "Installed plugins:"
          ls lib/ext | grep casutg

      # 5Ô∏è‚É£ Install Taurus (BZT)
      - name: Install Taurus
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install bzt

      # 6Ô∏è‚É£ Run Performance Tests with Taurus
      - name: Run Performance Tests with Taurus
        env:
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario }}
        run: |
          set -e
          mkdir -p performance-results

          echo "Scenario: ${TEST_SCENARIO}"

          bzt ${TEST_SCENARIO} \
            -o modules.jmeter.path=/opt/jmeter \
            -o modules.jmeter.version=5.6.3 \
            -o settings.artifacts-dir=performance-results \
            -report

          echo "‚úÖ Taurus execution completed"


      # 7Ô∏è‚É£ Generate JMeter HTML Report
      - name: Generate JMeter HTML Report
        if: always()
        run: |
          set +e
          echo "Searching for valid JTL file..."
      
          JTL=$(find performance-results \
            -name "*kpi.jtl" \
            -o -name "jmeter.jtl" \
            | head -1)
      
          if [ -z "$JTL" ]; then
            echo "‚ùå No valid JTL found for HTML report"
            exit 0
          fi
      
          echo "‚úÖ Using JTL: $JTL"
      
          mkdir -p jmeter-html-report
      
          /opt/jmeter/bin/jmeter \
            -g "$JTL" \
            -o jmeter-html-report
      
          echo "‚úÖ JMeter HTML report generated"

      # 8Ô∏è‚É£ Upload Taurus Results
      - name: Upload Taurus Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: taurus-performance-results
          path: performance-results/
          retention-days: 30

      # 9Ô∏è‚É£ Upload JMeter HTML Report
      - name: Upload JMeter HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report
          path: jmeter-html-report/
          retention-days: 30

      # üîü Extract Key Metrics (optional)
      - name: Extract Key Metrics
        if: always()
        run: |
          echo "=== PERFORMANCE METRICS SUMMARY ==="
          JTL=$(find performance-results -name "*.jtl" | head -1)

          if [ -n "$JTL" ]; then
            echo "Results file: $JTL"
            echo "Total samples:"
            tail -n +2 "$JTL" | wc -l
          else
            echo "No JTL file found"
          fi

          echo "=== WORKFLOW FINISHED ==="
