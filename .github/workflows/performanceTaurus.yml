name: Performance Tests (Taurus with JMeter)

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'load-test.yml'
      duration:
        description: 'Test duration (minutes)'
        required: false
        default: '5'

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout del c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Java 17
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3Ô∏è‚É£ Instalar JMeter
      - name: Install JMeter
        run: |
          JMETER_VERSION="5.6.3"
          
          echo "Installing JMeter ${JMETER_VERSION}..."
          curl -L "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" \
            | tar -xz
          
          sudo mv "apache-jmeter-${JMETER_VERSION}" /opt/jmeter
          
          # Agregar JMeter al PATH
          echo "/opt/jmeter/bin" >> $GITHUB_PATH
          
          # Verificar instalaci√≥n
          /opt/jmeter/bin/jmeter --version

      # 4Ô∏è‚É£ Instalar Plugins de JMeter (M√©todo directo - m√°s confiable)
      - name: Install JMeter Plugins
        run: |
          echo "Installing JMeter plugins..."
          
          # 1. Plugin Manager (para gesti√≥n futura si es necesario)
          curl -L "https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/1.7/jmeter-plugins-manager-1.7.jar" \
            -o /opt/jmeter/lib/ext/jmeter-plugins-manager.jar
          
          # 2. CmdRunner
          curl -L "https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar" \
            -o /opt/jmeter/lib/cmdrunner-2.3.jar
          
          # 3. Concurrency Thread Group Plugin (jpgc-casutg)
          curl -L "https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.13/jmeter-plugins-casutg-2.13.jar" \
            -o /opt/jmeter/lib/ext/jmeter-plugins-casutg-2.13.jar
          
          # 4. Dependencias necesarias
          curl -L "https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-cmn-jmeter/0.8/jmeter-plugins-cmn-jmeter-0.8.jar" \
            -o /opt/jmeter/lib/ext/jmeter-plugins-cmn-jmeter-0.8.jar
          
          # 5. JSON Plugins (√∫tiles para APIs REST)
          curl -L "https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-json/2.7/jmeter-plugins-json-2.7.jar" \
            -o /opt/jmeter/lib/ext/jmeter-plugins-json-2.7.jar
          
          # 6. Custom Thread Groups (adicional)
          curl -L "https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-custom-threads/0.1/jmeter-plugins-custom-threads-0.1.jar" \
            -o /opt/jmeter/lib/ext/jmeter-plugins-custom-threads-0.1.jar
          
          echo "Plugins installed successfully!"
          
          # Verificar instalaci√≥n de plugins
          echo "Verifying plugins installation..."
          ls -la /opt/jmeter/lib/ext/*.jar | grep -E "(casutg|cmn|json)"

      # 5Ô∏è‚É£ Instalar Taurus (BZT)
      - name: Install Taurus
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv python3-dev
          pip3 install --upgrade pip
          pip3 install bzt

      - name: Run Performance Tests with Taurus
        env:
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario || 'load-test.yml' }}
          TEST_DURATION: ${{ github.event.inputs.duration || '5' }}
        run: |
          echo "Running performance tests with scenario: ${TEST_SCENARIO}"
          echo "Test duration: ${TEST_DURATION} minutes"
          
          # 1. Crear directorio para resultados (si no existe)
          mkdir -p ./performance-results
          
          # 2. Configurar entorno para Taurus
          export JMETER_HOME=/opt/jmeter
          
          # 3. Ejecutar Taurus con configuraci√≥n CLI completa
          # La opci√≥n clave es: -o modules.jmeter.plugins-path=/opt/jmeter/lib/ext
          bzt ${TEST_SCENARIO} \
            -o modules.jmeter.path=/opt/jmeter \
            -o modules.jmeter.plugins-path=/opt/jmeter/lib/ext \
            -o modules.jmeter.detect-plugins=false \
            -o modules.jmeter.version=5.6.3 \
            -o modules.jmeter.properties.DURACION=${TEST_DURATION} \
            -o modules.jmeter.properties.USUARIOS=10 \
            -o settings.artifacts-dir=./performance-results \
            -o execution.0.concurrency=10 \
            -o execution.0.hold-for=${TEST_DURATION}m \
            -o execution.0.ramp-up=1m \
            -o execution.0.scenario=main_scenario \
            -o modules.blazemeter.token="" \
            -o modules.blazemeter.upload-artifacts=false \
            -o modules.blazemeter.send-report=false \
            -report
          
          echo "Taurus execution completed!"

      # 7Ô∏è‚É£ Generar reporte HTML de JMeter (si hay archivos JTL)
      - name: Generate JMeter HTML Report
        if: always()
        run: |
          echo "Generating JMeter HTML reports..."
          
          # Buscar archivos JTL generados
          JTL_FILES=$(find ./performance-results -name "*.jtl" -type f | head -1)
          
          if [ -n "$JTL_FILES" ] && [ -f "$JTL_FILES" ]; then
            echo "Found JTL file: ${JTL_FILES}"
            
            # Crear directorio para reporte HTML
            mkdir -p ./jmeter-html-report
            
            # Generar reporte HTML usando JMeter
            /opt/jmeter/bin/jmeter \
              -g "${JTL_FILES}" \
              -o ./jmeter-html-report
              
            echo "HTML report generated successfully!"
          else
            echo "No JTL files found for HTML report generation."
          fi

      # 8Ô∏è‚É£ Subir resultados de Taurus
      - name: Upload Taurus Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: taurus-performance-results
          path: |
            ./performance-results/
            **/*.jtl
            **/*.csv
            **/*.log
            **/*.yml
            **/*.xml
          retention-days: 30

      # 9Ô∏è‚É£ Subir reporte HTML de JMeter
      - name: Upload JMeter HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-report
          path: ./jmeter-html-report/
          retention-days: 30

      # üîü Publicar m√©tricas clave (opcional)
      - name: Extract Key Metrics
        if: always()
        run: |
          echo "Extracting key performance metrics..."
          
          # Buscar archivo de resultados principal
          RESULT_FILE=$(find ./performance-results -name "*kpi.jtl" -o -name "*.csv" | head -1)
          
          if [ -n "$RESULT_FILE" ] && [ -f "$RESULT_FILE" ]; then
            echo "=== PERFORMANCE METRICS SUMMARY ==="
            echo "Results file: ${RESULT_FILE}"
            
            # Extraer m√©tricas b√°sicas (ejemplo)
            if command -v awk &> /dev/null; then
              echo "Sample data from results:"
              head -5 "${RESULT_FILE}"
            fi
            
            # Contar n√∫mero de requests
            if [ -f "${RESULT_FILE}" ]; then
              TOTAL_REQUESTS=$(tail -n +2 "${RESULT_FILE}" | wc -l)
              echo "Total requests: ${TOTAL_REQUESTS}"
            fi
          else
            echo "No results file found for metrics extraction."
          fi
          
          echo "=== WORKFLOW COMPLETED ==="
