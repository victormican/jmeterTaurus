name: Performance Tests (Taurus + JMeter Nativo)

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'load-test.yml'
      duration:
        description: 'Test duration (minutes)'
        required: false
        default: '5'

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1️⃣ Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Configurar Java 17 (Necesario para JMeter)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3️⃣ Configurar Python (Necesario para Taurus)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4️⃣ Instalar JMeter y Plugins Manualmente
      - name: Install JMeter & Plugins manually
        run: |
          JMETER_VERSION="5.6.3"
          INSTALL_DIR="/opt/jmeter"
          
          echo "Installing JMeter ${JMETER_VERSION}..."
          curl -L "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.tgz" | tar -xz
          sudo mv "apache-jmeter-${JMETER_VERSION}" $INSTALL_DIR
          
          # Descargar Plugin Manager y CmdRunner
          curl -L https://jmeter-plugins.org/get/ -o $INSTALL_DIR/lib/ext/jmeter-plugins-manager.jar
          curl -L https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -o $INSTALL_DIR/lib/cmdrunner-2.3.jar
          
          # CORRECCIÓN AQUÍ: Quitamos 'jpgc-cmn' de la lista.
          # Se instalará solo automáticamente al instalar casutg.
          java -jar $INSTALL_DIR/lib/cmdrunner-2.3.jar --tool org.jmeterplugins.repository.PluginManagerCMD install jpgc-casutg,jpgc-json
          
          echo "JMeter and Plugins installed at $INSTALL_DIR"
          
          # Verificación opcional: Listar jars para que veas que cmn sí se bajó
          echo "Verificando dependencias instaladas:"
          ls $INSTALL_DIR/lib/ext/ | grep jmeter-plugins-cmn

      # 5️⃣ Instalar Taurus (BZT)
      - name: Install Taurus
        run: pip install bzt

      # 6️⃣ Ejecutar Taurus
      # CAMBIO CLAVE: Definimos un directorio de artefactos FIJO y apuntamos al JMeter instalado
      - name: Run Performance Tests
        env:
          TEST_SCENARIO: ${{ github.event.inputs.test_scenario || 'load-test.yml' }}
          TEST_DURATION: ${{ github.event.inputs.duration || '5' }}
        run: |
          echo "Running scenario: ${TEST_SCENARIO} for ${TEST_DURATION} minutes"
          
          # Ejecutamos Taurus apuntando al JMeter que instalamos manualmente
          bzt ${TEST_SCENARIO} \
            -o modules.jmeter.path=/opt/jmeter/bin/jmeter \
            -o modules.jmeter.version=5.6.3 \
            -o modules.jmeter.properties.DURACION=${TEST_DURATION} \
            -o modules.jmeter.properties.USUARIOS=10 \
            -o settings.artifacts-dir=performance-results \
            -o modules.blazemeter.report-name="GitHub Action Test" \
            -o modules.blazemeter.test="Taurus JMeter Test" 
          
          # Nota: Quité los flags de 'detect-plugins=false' y 'plugins-path' complejos.
          # Al apuntar modules.jmeter.path correctamente, Taurus usará los plugins de /opt/jmeter/lib/ext

      # 7️⃣ Generar reporte HTML de JMeter Nativo
      # Buscamos el kpi.jtl generado por Taurus dentro de la carpeta fija
      - name: Generate JMeter HTML Report
        if: always()
        run: |
          echo "Looking for JTL files..."
          JTL_FILE="performance-results/kpi.jtl"
          
          if [ -f "$JTL_FILE" ]; then
            echo "JTL found. Generating Dashboard..."
            mkdir -p jmeter-dashboard
            
            /opt/jmeter/bin/jmeter -g "$JTL_FILE" -o jmeter-dashboard
            echo "Dashboard generated successfully."
          else
            echo "ERROR: kpi.jtl not found in performance-results/"
            ls -R performance-results/
          fi

      # 8️⃣ Subir TODO (Taurus XML + Logs + JMeter Dashboard)
      # Unificamos en un solo zip para facilitar la descarga
      - name: Upload All Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-performance-report
          path: |
            performance-results/
            jmeter-dashboard/
          retention-days: 30
